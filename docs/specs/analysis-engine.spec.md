```markdown
# Analysis Engine — Specification

## Purpose
The **Analysis Engine** is the core computational component of the phishing detection system. It transforms raw DNS request data into a comprehensive risk assessment by orchestrating four specialized metric calculators and a risk aggregator.

It operates in real-time with strict performance constraints (**5–50 ms per analysis**) and produces a normalized risk score `R ∈ [0, 1]` and a discrete threat level.

---

## Input / Output

```json
{
  "input": {
    "domain": "string",
    "context": {
      "timestamp": "number",
      "referrer": "string | null",
      "url": "string",
      "userAgent": "string",
      "hour": "number",
      "dayOfWeek": "0-6"
    }
  },
  "output": {
    "score": { "type": "number", "minimum": 0, "maximum": 1 },
    "level": { "enum": ["CRITICAL", "HIGH", "MEDIUM", "LOW"] },
    "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
    "metrics": {
      "M1": "number",
      "M2": "number",
      "M3": "number",
      "M4": "number"
    },
    "reasoning": "object"
  }
}
```

---

## Pipeline Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     Analysis Engine                          │
│                                                              │
│  Input: Domain + Context                                    │
│     ↓                                                        │
│  ┌──────────────────────────────────────────────────────┐  │
│  │            Parallel Metric Calculation                │  │
│  │  Rate (M1)  │  Entropy (M2)  │  Reputation (M3)  │  Behavior (M4)  │  │
│  └──────────────────────────────────────────────────────┘  │
│     ↓                                                        │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              Risk Aggregator (Formula 12)             │  │
│  │  R = w1×M1 + w2×M2 + w3×M3 + w4×M4                    │  │
│  └──────────────────────────────────────────────────────┘  │
│     ↓                                                        │
│  ┌──────────────────────────────────────────────────────┐  │
│  │           Risk Classification (Formula 14)           │  │
│  │  R ≥ 0.8 → CRITICAL  │  0.6 ≤ R < 0.8 → HIGH          │  │
│  │  0.4 ≤ R < 0.6 → MEDIUM  │  R < 0.4 → LOW            │  │
│  └──────────────────────────────────────────────────────┘  │
│     ↓                                                        │
│  Output: Risk Assessment                                    │
└─────────────────────────────────────────────────────────────┘
```

---

## Metric Groups

| Group | Calculator | Metric | Range | Weight (w) | Focus |
|-------|------------|--------|-------|------------|-------|
| 1 | Rate | M1 | [0,1] | 0.15 | Request intensity & burst detection |
| 2 | Entropy | M2 | [0,1] | 0.25 | Domain name randomness (DGA) |
| 3 | Reputation | M3 | [0,1] | 0.40 | Threat intel, WHOIS, SSL, age |
| 4 | Behavior | M4 | [0,1] | 0.20 | User access patterns & anomalies |

> **Σ wᵢ = 1.0**

---

## Mathematical Foundation

### Formula 12 — Risk Aggregation
```
R = 0.15×M1 + 0.25×M2 + 0.40×M3 + 0.20×M4
```

### Formula 14 — Risk Classification
| Risk Level | Threshold |
|------------|-----------|
| CRITICAL   | R ≥ 0.8   |
| HIGH       | 0.6 ≤ R < 0.8 |
| MEDIUM     | 0.4 ≤ R < 0.6 |
| LOW        | R < 0.4   |

---

## Confidence Calculation
```
Confidence = (Σ (wᵢ × Cᵢ × Aᵢ)) / (Σ (wᵢ × Aᵢ))

Cᵢ = confidence of metric i
Aᵢ = 1 if metric available, 0 otherwise
```

**Adjustments:**
- All 4 metrics available → +10%
- Reputation missing → −40%
- High conflict between M1 and M3 → −30%

---

## Requirements

| Requirement | Value |
|-----------|-------|
| Latency | ≤ 50 ms (95th percentile) |
| Cache Hit Rate | ≥ 80 % for reputation |
| History for Behavior | ≥ 5 requests, ≥ 1 day |
| API Timeouts | ≤ 5 s per external call |
| Memory per Domain | ≤ 2 KB |

---

## Related Documentation

- `specs/rate.spec.md` – Group 1 metrics
- `specs/entropy.spec.md` – Group 2 metrics
- `specs/reputation.spec.md` – Group 3 metrics
- `specs/behavior.spec.md` – Group 4 metrics
- `specs/risk.spec.md` – Aggregation & classification
- `api/*.api.md` – Public method signatures
- `examples/analysis-engine.examples.md` – Usage samples

---

*This file contains **no code**. Implementation is generated by Cursor from `api/*.api.md` and `specs/*.spec.md`.*
```