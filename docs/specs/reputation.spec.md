```markdown
# Reputation Metric Calculator — Specification

## Purpose
The **Reputation Metric Calculator** computes **M3 ∈ [0, 1]** — a normalized **threat intelligence and domain trustworthiness score**. It integrates:

- **Threat feeds** (PhishTank, Google Safe Browsing, OpenPhish)  
- **WHOIS metadata** (age, privacy, registrar)  
- **SSL/TLS certificate validation**  
- **Additional risk factors**

It is the **third stage** in the Analysis Engine pipeline and provides the **strongest direct signal** of malicious intent.

---

## Input / Output

```json
{
  "input": {
    "domain": "string"
  },
  "output": {
    "value": { "type": "number", "minimum": 0, "maximum": 1 },
    "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
    "detailed": {
      "sources": {
        "phishtank": "object | null",
        "safeBrowsing": "object | null",
        "openphish": "object | null"
      },
      "whois": "object | null",
      "ssl": "object | null",
      "ageDays": "number",
      "penalties": "object"
    }
  }
}
```

---

## Source Weighting (Default)

| Source | Weight | Confidence Factor |
|--------|--------|-------------------|
| **PhishTank** | `0.40` | Fresh (<24h): 1.0 |
| **Google Safe Browsing** | `0.35` | Recent (<7d): 0.9 |
| **OpenPhish** | `0.25` | Stale (>7d): 0.7 |

> **Σ weights = 1.0**

---

## Threat Intel Source Scoring

```
S_i = 1.0  if domain listed
S_i = 0.0  if not listed or no data
```

---

## Domain Age Penalty

| Age | Penalty |
|-----|--------|
| < 7 days | **+0.30** |
| 7–30 days | +0.20 |
| 30–90 days | +0.10 |
| ≥ 90 days | 0.00 |

---

## SSL & WHOIS Penalties

| Condition | Penalty |
|---------|--------|
| **Invalid / missing SSL** | +0.15 |
| **WHOIS privacy enabled** | +0.10 |
| **Self-signed cert** | +0.20 |
| **Domain mismatch** | +0.25 |

---

## Final M3 Calculation

```
M3 = Σ (w_i × S_i × C_i) + AgePenalty + SSLPenalty + WHOISPenalty
```

> Clamped to `[0, 1]`

---

## Confidence Calculation

```
Confidence = (Σ (w_i × C_i × A_i)) / (Σ (w_i × A_i))

A_i = 1 if source responded, 0 otherwise
C_i = freshness factor
```

**Adjustments:**
- **All 3 sources available** → +15%
- **No WHOIS data** → −20%
- **API timeout** → treat as `A_i = 0`

---

## Requirements

| Requirement | Value |
|-----------|-------|
| **Latency** | ≤ 30 ms (with cache) |
| **API Timeout** | 5 s per source |
| **Cache TTL** | 24 hours |
| **Rate Limits** | Honor API quotas |
| **Fallback** | Degraded mode if all APIs fail |

---

## API Endpoints (Configurable)

| Service | Endpoint | Method | Auth |
|-------|----------|--------|------|
| PhishTank | `POST /checkurl/` | JSON | API Key |
| Safe Browsing | `POST /v4/threatMatches:find` | JSON | API Key |
| OpenPhish | `GET /feed.txt` | TXT | None |

---

## Architecture Flow

```
Input Domain → 
  [Parallel] Query APIs + WHOIS + SSL → 
  Apply Weights & Confidence → 
  Add Penalties → 
  Normalize → M3 + Confidence
```

---

## Example Outputs

| Domain | M3 | Level | Key Factors |
|-------|-----|-------|-----------|
| `paypal-secure-login.com` | **0.92** | CRITICAL | Listed in PhishTank, 12 days old |
| `google.com` | 0.05 | LOW | Not listed, 25+ years old |
| `newbank-login.xyz` | 0.78 | HIGH | New domain, privacy enabled |

---

## Related Documentation

- `api/reputation.api.md` – Public method signatures
- `examples/analysis-engine.examples.md` – Usage
- `05-implementation/external-services.md` – API integration details
- `07-data-structures/domain-record.md` – WHOIS/SSL schema

---

*This file contains **no code**. Implementation is generated by Cursor from `api/reputation.api.md` and this specification.*
```