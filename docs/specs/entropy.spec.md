```markdown
# Entropy Metric Calculator — Specification

## Purpose
The **Entropy Metric Calculator** computes **M2 ∈ [0, 1]** — a normalized anomaly score for **domain name randomness**. It detects:

- **Algorithmically generated domains (DGA)**  
- **Typosquatting**  
- **Homoglyph attacks**  
- **Suspicious structural patterns**

It is the **second stage** in the Analysis Engine pipeline and provides the **structural anomaly signal**.

---

## Input / Output

```json
{
  "input": {
    "domain": "string"  // e.g., "x7k9p2m4q8r5.example.co.uk"
  },
  "output": {
    "value": { "type": "number", "minimum": 0, "maximum": 1 },
    "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
    "detailed": {
      "sld": "string",
      "rawEntropy": "number",
      "maxEntropy": "number",
      "normalizedEntropy": "number",
      "charSet": "string",
      "patterns": {
        "typosquatting": "boolean",
        "typosquattingTarget": "string | null",
        "homoglyphs": "boolean",
        "homoglyphCount": "number",
        "digitRatio": "number",
        "hasConsecutiveChars": "boolean"
      },
      "penalties": "object"
    }
  }
}
```

---

## Preprocessing Steps

1. **Extract Second-Level Domain (SLD)**  
   `sub.example.co.uk` → `example`  
   `xn--e1afmkfd.xn--p1ai` → `пример`

2. **Remove TLD**  
   `example.co.uk` → `example`

3. **Normalize case** → lowercase

4. **Decode Punycode** → Unicode

---

## Shannon Entropy

```
H(X) = -Σ [p(xi) × log₂(p(xi))]
```

| Character Set | Size | H_max (bits) |
|---------------|------|--------------|
| Lowercase (a–z) | 26 | 4.70 |
| Alphanumeric | 36 | **5.17** |
| + Hyphen | 37 | 5.21 |
| Full ASCII | 95 | 6.57 |

---

## Normalization to M2 ∈ [0, 1]

```
M2 = H(X) / H_max
```

| Entropy Range | Interpretation | M2 |
|---------------|----------------|-----|
| ≤ 2.5 | Dictionary word | ≤ 0.48 |
| 3.0–3.5 | Mixed word/number | 0.58–0.68 |
| ≥ 4.5 | **High randomness** | ≥ 0.87 |

---

## Pattern Detection & Penalties

| Pattern | Detection | Penalty |
|--------|----------|--------|
| **Typosquatting** | Levenshtein ≤ 2 vs known brand | +0.30 |
| **Homoglyphs** | Confusable Unicode chars | +0.25 |
| **High digit ratio** | digits / length ≥ 0.6 | +0.15 |
| **Consecutive chars** | 3+ identical | +0.10 |

```
M2_final = min(1.0, M2_normalized + Σ penalties)
```

---

## Confidence Calculation

```
Confidence = 
  (length ≥ 6 ? 1.0 : 0.7) × 
  (charSet ∈ [alpha, alnum] ? 1.0 : 0.9) × 
  (patternsDetected > 0 ? 1.1 : 1.0)
```

> Capped at 1.0

---

## Requirements

| Requirement | Value |
|-----------|-------|
| **Latency** | ≤ 3 ms |
| **Min domain length** | 3 chars |
| **Max domain length** | 63 chars |
| **Cache** | Precomputed SLD + entropy (TTL: 24h) |
| **Memory** | ≤ 512 B per domain |

---

## Benchmark Examples

| Domain | SLD | H(X) | M2 | Verdict |
|-------|-----|------|-----|--------|
| `google` | `google` | 2.32 | 0.45 | Low |
| `paypal-secure` | `paypal-secure` | 3.62 | 0.70 | Medium |
| `x7k9p2m4q8r5` | `x7k9p2m4q8r5` | 4.95 | 0.96 | **High (DGA)** |

---

## Architecture Flow

```
Input Domain → Preprocess (SLD) → 
       Char Frequency → Shannon Entropy → 
       Detect Patterns → Apply Penalties → 
       Normalize → M2 + Confidence
```

---

## Related Documentation

- `api/entropy.api.md` – Public method signatures
- `examples/analysis-engine.examples.md` – Usage
- `02-mathematical-model/formulas.md` – Shannon entropy
- `07-data-structures/domain-record.md` – Domain format

---

*This file contains **no code**. Implementation is generated by Cursor from `api/entropy.api.md` and this specification.*
```