```markdown
# Rate Metric Calculator — Specification

## Purpose
The **Rate Metric Calculator** computes **M1 ∈ [0, 1]** — a normalized anomaly score for **request intensity and frequency patterns**. It detects:

- **Burst attacks** (sudden spikes)
- **High sustained rates** (bot scanning)
- **Unusual short-term activity**

It is the **first stage** in the Analysis Engine pipeline and provides the **request intensity signal**.

---

## Input / Output

```json
{
  "input": {
    "domain": "string",
    "context": {
      "timestamp": "number",
      "url": "string",
      "referrer": "string | null"
    }
  },
  "output": {
    "value": { "type": "number", "minimum": 0, "maximum": 1 },
    "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
    "detailed": {
      "rates": {
        "oneMinute": "number",
        "fiveMinute": "number",
        "fifteenMinute": "number"
      },
      "burst": {
        "detected": "boolean",
        "multiplier": "number",
        "peakRate": "number"
      },
      "baseline": "number",
      "zScore": "number | null"
    }
  }
}
```

---

## Time Windows

| Window | Duration | Purpose |
|--------|----------|--------|
| **1-minute** | 60 s | Detect **immediate bursts** |
| **5-minute** | 300 s | Capture **short-term trends** |
| **15-minute** | 900 s | Establish **medium-term baseline** |

> Rates are computed as:  
> `Rate(W) = RequestCount(W) / (W / 60)` requests per minute

---

## Mathematical Foundation

### Baseline Rate
```
R_baseline = Average historical rate (req/min) over last 7 days
```

### Anomaly Score (before normalization)
```
S = max(
  z_score(oneMinuteRate),
  (currentRate - R_baseline) / R_threshold
)
```

### Z-Score (for 1-minute window)
```
z = (R_current - R_mean) / σ_rate
```

### Burst Detection
```
Burst = R_current > R_baseline × BurstMultiplier
```
> Default `BurstMultiplier = 3.0`

---

## Normalization to M1 ∈ [0, 1]

```
M1 = min(1.0, S / 3.0)
```

| Z-Score | Interpretation | M1 |
|--------|----------------|-----|
| ≤ 1.0 | Normal | ≤ 0.33 |
| 2.0 | Suspicious | ~0.67 |
| ≥ 3.0 | Anomalous | 1.0 |

---

## Confidence Calculation

```
Confidence = min(1.0, 
  (historyDays / 7) × 
  (requestCount / 50) × 
  (1.0 - burstPenalty)
)
```

| Factor | Condition | Effect |
|-------|-----------|--------|
| **History depth** | ≥ 7 days | +full weight |
| **Sample size** | ≥ 50 requests | +full weight |
| **Burst detected** | Yes | −0.2 |

---

## Requirements

| Requirement | Value |
|-----------|-------|
| **Latency** | ≤ 5 ms |
| **History required** | ≥ 5 requests |
| **Baseline stability** | ≥ 3 days of data |
| **Cache** | Per-domain rate windows (TTL: 1 min) |
| **Memory** | ≤ 1 KB per domain |

---

## Thresholds (Configurable)

```ts
{
  lowRate: 10,      // req/min
  normalRate: 20,
  highRate: 50,
  criticalRate: 100
}
```

---

## Architecture Flow

```
Input → Load DomainStats → 
       Calculate Rates (1m,5m,15m) → 
       Detect Burst → 
       Compute Z-Score → 
       Normalize → M1 + Confidence
```

---

## Related Documentation

- `api/rate.api.md` – Public method signatures
- `examples/analysis-engine.examples.md` – Usage
- `02-mathematical-model/formulas.md` – Full formula list
- `07-data-structures/domain-record.md` – Time series format

---

*This file contains **no code**. Implementation is generated by Cursor from `api/rate.api.md` and this specification.*
```