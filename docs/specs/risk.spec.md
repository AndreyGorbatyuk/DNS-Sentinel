```markdown
# Risk Aggregator — Specification

## Purpose
The **Risk Aggregator** is the **final stage** of the Analysis Engine. It combines four normalized metrics:

- `M1` — Request Rate  
- `M2` — Entropy (DGA)  
- `M3` — Reputation  
- `M4` — Behavior  

into a **single risk score** `R ∈ [0, 1]` and a **discrete threat level** using **Formula 12** and **Formula 14**.

It also computes **confidence**, detects **metric conflicts**, and generates **human-readable reasoning**.

---

## Input / Output

```json
{
  "input": {
    "requestRate": "RateMetricResult",
    "entropy": "EntropyMetricResult",
    "reputation": "ReputationMetricResult",
    "behavior": "BehaviorMetricResult"
  },
  "output": {
    "score": { "type": "number", "minimum": 0, "maximum": 1 },
    "level": { "enum": ["CRITICAL", "HIGH", "MEDIUM", "LOW"] },
    "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
    "metrics": { "M1": "number", "M2": "number", "M3": "number", "M4": "number" },
    "weights": { "M1": "number", "M2": "number", "M3": "number", "M4": "number" },
    "reasoning": {
      "primary": "string[]",
      "factors": "string[]",
      "recommendations": "string[]",
      "metricContributions": "object"
    },
    "timestamp": "number"
  }
}
```

---

## Default Weights (Formula 12)

| Metric | Weight | Rationale |
|-------|--------|---------|
| **M1** | `0.15` | Intensity signal |
| **M2** | `0.25` | Structural anomaly |
| **M3** | `0.40` | **Strongest direct signal** |
| **M4** | `0.20` | Contextual deviation |

> **Σ wᵢ = 1.0**

---

## Risk Score (Formula 12)

```
R = w1×M1 + w2×M2 + w3×M3 + w4×M4
```

---

## Risk Classification (Formula 14)

| Level | Threshold |
|-------|-----------|
| **CRITICAL** | `R ≥ 0.80` |
| **HIGH**     | `0.60 ≤ R < 0.80` |
| **MEDIUM**   | `0.40 ≤ R < 0.60` |
| **LOW**      | `R < 0.40` |

---

## Confidence Calculation

```
Confidence = (Σ (wᵢ × Cᵢ × Aᵢ)) / (Σ (wᵢ × Aᵢ))
```

- `Cᵢ` = confidence from metric `i`  
- `Aᵢ` = 1 if metric available, 0 otherwise

### Adjustments

| Condition | Δ Confidence |
|---------|---------------|
| **All 4 metrics available** | **+0.10** |
| **M3 (Reputation) missing** | **−0.40** |
| **High conflict detected** | **−0.30** |
| **≥2 sources agree on threat** | **+0.20** |

> Final confidence clamped to `[0, 1]`

---

## Metric Conflict Detection

| Conflict Type | Condition | Penalty |
|-------------|----------|--------|
| **Rate vs Reputation** | `|M1 − M3| ≥ 0.6` | −0.30 |
| **Entropy vs Behavior** | `M2 ≥ 0.7` and `M4 ≤ 0.3` | −0.25 |

> Conflict = `true` if any condition met

---

## User Sensitivity Presets

| Mode | Score Adjustment |
|------|------------------|
| **Strict**   | `R × 1.15` |
| **Balanced** | `R × 1.00` |
| **Relaxed**  | `R × 0.85` |

> Applied **after** Formula 12, **before** classification

---

## Reasoning Generation

### Primary Signals (Priority Order)
1. **M3 ≥ 0.7** → "Listed in threat intelligence"
2. **M1 ≥ 0.8** → "Request burst detected"
3. **M2 ≥ 0.8** → "DGA-like domain structure"
4. **M4 ≥ 0.7** → "Unusual access pattern"

### Recommendations
| Level | Action |
|-------|--------|
| CRITICAL | **Block + Alert** |
| HIGH | Warn + Confirm |
| MEDIUM | Log + Monitor |
| LOW | Allow |

---

## Architecture Flow

```
Metrics (M1–M4) → 
  Load Weights → 
  Compute R (Formula 12) → 
  Apply Sensitivity → 
  Classify (Formula 14) → 
  Compute Confidence → 
  Detect Conflicts → 
  Generate Reasoning → 
  Output RiskAssessment
```

---

## Requirements

| Requirement | Value |
|-----------|-------|
| **Latency** | ≤ 2 ms |
| **Deterministic** | Same inputs → same output |
| **Configurable weights** | Runtime reload |
| **No external calls** | Pure computation |
| **Thread-safe** | Concurrent domain analysis |

---

## Example Outputs

| M1 | M2 | M3 | M4 | R | Level | Confidence |
|----|----|----|----|---|-------|------------|
| 0.9 | 0.8 | 0.95 | 0.7 | **0.91** | **CRITICAL** | 0.92 |
| 0.2 | 0.3 | 0.1 | 0.1 | **0.15** | **LOW** | 0.98 |
| 0.7 | 0.6 | 0.3 | 0.8 | **0.56** | **MEDIUM** | 0.65 |

---

## Related Documentation

- `api/risk.api.md` – Public method signatures
- `examples/analysis-engine.examples.md` – Full pipeline
- `02-mathematical-model/risk-aggregation.md` – Formula 12
- `02-mathematical-model/normalization.md` – Confidence
- `07-data-structures/risk-assessment.md` – Output schema

---

*This file contains **no code**. Implementation is generated by Cursor from `api/risk.api.md` and this specification.*
```