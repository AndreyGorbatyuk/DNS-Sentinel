```markdown
# Behavior Metric Calculator — Specification

## Purpose
The **Behavior Metric Calculator** computes **M4 ∈ [0, 1]** — a normalized **user-specific behavioral anomaly score**. It detects deviations from established patterns in:

- **Access timing** (hour of day, day of week)  
- **Request frequency** (rate anomalies)  
- **Navigation context** (referrer, direct access, sensitive paths)

It is the **fourth stage** in the Analysis Engine pipeline and provides the **contextual anomaly signal**.

---

## Input / Output

```json
{
  "input": {
    "domain": "string",
    "context": {
      "timestamp": "number",
      "url": "string",
      "referrer": "string | null",
      "userAgent": "string",
      "hour": "number",
      "dayOfWeek": "number",
      "requestType": "string"
    }
  },
  "output": {
    "value": { "type": "number", "minimum": 0, "maximum": 1 },
    "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
    "detailed": {
      "temporal": "object | null",
      "frequency": "object | null",
      "navigation": "object | null",
      "history": {
        "requestCount": "number",
        "historyDays": "number"
      }
    }
  }
}
```

---

## Behavioral Profile (Per Domain)

| Field | Meaning |
|------|--------|
| `accessHours[]` | List of hours (0–23) user typically visits |
| `dayFrequencies[7]` | Requests per day of week |
| `avgRate` | Baseline requests/minute |
| `stdDevRate` | Standard deviation of rate |
| `typicalReferrers[]` | Top referrer domains + counts |
| `lastUpdated` | Timestamp of last update |

---

## Anomaly Components

### 1. **Temporal Anomaly** (Weight: 0.3)

```
z_hour = (currentHour - μ_hour) / σ_hour
z_day  = (currentDay - μ_day) / σ_day
```

```
TemporalScore = min(1.0, (abs(z_hour) + abs(z_day)) / 4.0)
```

> `μ_hour` = most frequent access hour  
> `σ_hour` = standard deviation of access times

---

### 2. **Frequency Anomaly** (Weight: 0.4)

```
z_rate = (currentRate - avgRate) / stdDevRate
```

```
FrequencyScore = min(1.0, z_rate / 3.0)
```

> Uses **1-minute rolling window**

---

### 3. **Navigation Anomaly** (Weight: 0.3)

| Condition | Score |
|--------|-------|
| **No referrer + sensitive path** (e.g., `/login`) | +0.8 |
| **Unknown referrer domain** | +0.5 |
| **Direct access to non-homepage** | +0.4 |
| **Referrer mismatch with typical** | +0.3 |

---

## Final M4 (Weighted Sum)

```
M4 = 0.3×Temporal + 0.4×Frequency + 0.3×Navigation
```

> Clamped to `[0, 1]`

---

## Confidence Calculation

```
Confidence = min(1.0,
  (requestCount / 50) ×
  (historyDays / 7) ×
  (1.0 + 0.1 × componentsAvailable)
)
```

| Condition | Effect |
|---------|--------|
| **< 5 requests** | Confidence = 0 |
| **< 1 day history** | Confidence ≤ 0.3 |
| **All 3 components** | +0.1 bonus |

---

## Minimum History Requirements

| Metric | Minimum |
|-------|--------|
| **Requests** | 5 |
| **Days** | 1 |
| **Rate samples** | 10 (for stdDev) |

> If not met → `M4 = 0.5`, `confidence = 0`

---

## Sensitive Paths (Configurable)

```ts
[
  "/login", "/signin", "/auth",
  "/admin", "/dashboard",
  "/payment", "/checkout"
]
```

---

## Architecture Flow

```
Input + Context → 
  Load BehaviorProfile → 
  [Parallel] Temporal | Frequency | Navigation → 
  Weighted Sum → M4 + Confidence → 
  Update Profile
```

---

## Example Scenarios

| Scenario | M4 | Reason |
|--------|-----|--------|
| 3 AM access to `/login` (user usually 9–5) | **0.88** | Temporal + Navigation |
| 100 req/min to API (normal: 2/min) | **0.95** | Frequency burst |
| Direct access to `example.com` | 0.10 | Normal behavior |

---

## Requirements

| Requirement | Value |
|-----------|-------|
| **Latency** | ≤ 8 ms |
| **Profile size** | ≤ 1.5 KB per domain |
| **Update frequency** | After every request |
| **Eviction** | LRU, max 10k domains |
| **Persistence** | Optional (sync to IndexedDB) |

---

## Related Documentation

- `api/behavior.api.md` – Public method signatures
- `examples/analysis-engine.examples.md` – Usage
- `07-data-structures/domain-record.md` – Profile schema
- `03-architecture/components/storage-layer/domain-statistics.md` – Storage

---

*This file contains **no code**. Implementation is generated by Cursor from `api/behavior.api.md` and this specification.*
```